<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core" xmlns:forgeview="http://jboss.org/forge/view"
	xmlns:o="http://omnifaces.org/ui" xmlns:p="http://primefaces.org/ui"
	template="/resources/scaffold/pageTemplate.xhtml">

	<ui:param name="pageTitle" value="Actions" />

	<ui:define name="header">
	</ui:define>
	<ui:define name="subheader">Aktionen</ui:define>
	<ui:define name="footer" />

	<ui:define name="main">

		<p:log id="pfLog" rendered="false"/>
		<h:outputScript target="body">
		//<![CDATA[
			function log(elmnt, event) {
				//console.log('Pfad: '+event.ctrlKey+'/'+event.code+' On: '+elmnt);
				if (event.ctrlKey && event.code=='Enter') {
					var el = $('#query\\:#ExecuteQuery');
					el = document.getElementById('query:ExecuteQuery');
					console.log('calling:  '+el);
					try {
						el.click();
						console.log("clicked: "+el);
					} catch(err) {
						console.log("fail: "+err);
					}
				}
			}
		//]]>
		</h:outputScript>

		<h:form id="download">
			<h:messages />
			<h:panelGrid styleClass="buttons" columns="8">
				<h:commandLink value="Download Gesamt" action="#{downloadBean.downloadAll()}" styleClass="btn btn-primary"
					disabled="#{!downloadBean.downloadAllowed}" />
				<h:commandLink value="Download Vor-Registrierung" action="#{downloadBean.downloadVorRegistrierung()}"
					styleClass="btn btn-primary" disabled="#{!downloadBean.downloadAllowed}" />
                <h:commandLink value="Download Registrierung" action="#{downloadBean.downloadRegistrierung()}"
                    styleClass="btn btn-primary" disabled="#{!downloadBean.downloadAllowed}" />
                <h:commandLink value="Download Nach-Registrierung" action="#{downloadBean.downloadNachRegistrierung()}"
                    styleClass="btn btn-primary" disabled="#{!downloadBean.downloadAllowed}" />
                <h:outputLabel value="Nur NeuReg:" />
                <h:selectBooleanCheckbox value="#{downloadBean.notRegisteredOnly}" immediate="true" disabled="#{!sessionBean.regActionsAllowed}"/>
                <h:outputLabel value="Mit RegUpdate:" />
                <h:selectBooleanCheckbox value="#{downloadBean.updateRegistered}" immediate="true" disabled="#{!sessionBean.regActionsAllowed}"/>

				<h:commandLink value="Download MitBuchgn" action="#{downloadBean.downloadAllWithBookings()}" styleClass="btn btn-primary"
					disabled="#{!downloadBean.downloadAllowed}" />
				<h:outputText value="" />
				<h:outputText value="" />
				<h:outputText value="" />
			</h:panelGrid>

		</h:form>

		<h:form id="query">
			<p:hotkey id="hotKey" bind="ctrl+x" handler="alert($('#ExecuteQuery')); $('#ExecuteQuery').click()"/>
			<p:messages />
			<h:panelGroup id="queryPanel">
				<h:panelGroup layout="block" id="actionsQueries">
					<ui:repeat value="#{downloadBean.queries}" var="query">
						<h:commandLink actionListener="#{downloadBean.executeQuery(query.id)}" value="#{query.ckey}"
							styleClass="btn btn-primary" title="#{query.toTitle()}">
							<f:ajax execute="@this" render="@form" />
						</h:commandLink>
					</ui:repeat>
				</h:panelGroup>
				<h:panelGrid columns="4" rendered="#{downloadBean.configuration != null}">
					<h:outputLabel value="Query:" />
					<h:outputText value="#{downloadBean.configuration.ckey}" />
					<h:commandLink action="#{downloadBean.downloadResults()}" value="Download" styleClass="btn btn-primary"
						title="Download von: #{downloadBean.configuration.ckey}"/>
					<h:outputText value="" />
				</h:panelGrid>

				<f:ajax>
					<h:panelGroup layout="block" rendered="#{memberBean.admin}">
						<h:panelGrid columns="4">
							<h:outputLabel value="Query" />
							<h:panelGroup>
								<h:outputLabel value="NativeQuery" />
								<h:selectBooleanCheckbox value="#{downloadBean.nativeQuery}" immediate="true" />
							</h:panelGroup>
							<h:commandLink id="ExecuteQuery" actionListener="#{downloadBean.executeQuery()}" value="Query" styleClass="btn btn-primary" title="Abfrage: #{downloadBean.query}">
								<f:ajax execute="@form" render="results messages" />
							</h:commandLink>
							<h:outputText value="" />
						</h:panelGrid>
						<h:panelGroup>
							<h:inputTextarea id="queryQuery" value="#{downloadBean.query}" style="width:80%;height:5em;" immediate="true" onkeyup="log(this, event)"/>
							<h:message for="queryQuery" />
							<h:outputText value="" />
						</h:panelGroup>
					</h:panelGroup>
					<h:messages id="messages" />

					<h:panelGroup id="results" layout="block" rendered="#{not empty downloadBean.results}">
						<h:panelGroup id="queryResults" layout="block" binding="#{downloadBean.dataTableGroup}" />
					</h:panelGroup>
				</f:ajax>
			</h:panelGroup>
		</h:form>

	</ui:define>

</ui:composition>